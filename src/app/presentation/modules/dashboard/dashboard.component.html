<div class="dashboard">
  <!-- Brand Header -->
  <header class="brand">
    <div class="brand-left">
      <img src="logo1.png" alt="StrideSense" class="brand-logo" />
      <span class="brand-name">StrideSense</span>
    </div>
    <div class="brand-right">
      @if (currentUser(); as user) {
        <span class="brand-user">{{ user.name }}</span>
      }
      <button class="btn-logout" (click)="logout()" title="Cerrar sesión">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Risk Card -->
  <section class="risk-card" routerLink="/risk">
    <div class="risk-card__header">
      <h2>Riesgo Actual</h2>
    </div>

    @if (riskLoading()) {
      <div class="risk-card__body">
        <p class="loading-text">Cargando...</p>
      </div>
    } @else if (riskSummary(); as risk) {
      <div class="risk-card__body">
        <div class="donut">
          <svg viewBox="0 0 120 120">
            <!-- Outer ring: rule-based overall score -->
            <circle cx="60" cy="60" r="54" fill="none" stroke="#e8e8e8" stroke-width="10"/>
            <circle cx="60" cy="60" r="54"
                    fill="none"
                    [attr.stroke]="riskColor()"
                    stroke-width="10"
                    stroke-linecap="round"
                    [attr.stroke-dasharray]="riskCircumference"
                    [attr.stroke-dashoffset]="riskDashOffset()"
                    transform="rotate(-90 60 60)"/>
            <!-- Inner ring: ML prediction score -->
            @if (mlPrediction()) {
              <circle cx="60" cy="60" r="40" fill="none" stroke="#e8e8e8" stroke-width="8"/>
              <circle cx="60" cy="60" r="40"
                      fill="none"
                      [attr.stroke]="mlColor()"
                      stroke-width="8"
                      stroke-linecap="round"
                      [attr.stroke-dasharray]="mlCircumference"
                      [attr.stroke-dashoffset]="mlDashOffset()"
                      transform="rotate(-90 60 60)"/>
            }
          </svg>
          <div class="donut__icon">
            <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm-3.5 6.5 1.5-3.5h4l1.5 3.5-2.5 3v5h-2.5v-5l-2-3Z"
                    fill="#2ec4b6" stroke="#2ec4b6" stroke-width="0.3" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
        <p class="risk-card__level" [class]="'risk-' + risk.overallLevel">{{ translateLevel(risk.overallLevel) }}</p>
        <p class="risk-card__score">{{ risk.overallScore }}% esfuerzo</p>
        @if (mlPrediction(); as ml) {
          <p class="risk-card__ml-badge" [class]="'risk-' + ml.level">ML · {{ ml.score }}%</p>
        }
      </div>
    } @else {
      <div class="risk-card__body">
        <p class="loading-text">Sin datos de riesgo</p>
      </div>
    }
  </section>

  <!-- Metrics Row -->
  <div class="metrics-row">
    <!-- Recent Session -->
    <div class="metric-card recent-session" routerLink="/sessions">
      <h3>Sesión Reciente</h3>
      @if (sessionsLoading()) {
        <p class="loading-text">...</p>
      } @else if (latestSession(); as session) {
        <div class="metric-card__values">
          <div class="metric-item">
            <span class="metric-item__value">{{ session.distanceKm ?? '—' }}</span>
            <span class="metric-item__unit">km</span>
            <span class="metric-item__label">Distancia</span>
          </div>
          <div class="metric-item">
            <span class="metric-item__value">{{ session.durationMinutes }}</span>
            <span class="metric-item__unit">min</span>
          </div>
          <div class="metric-item">
            <span class="metric-item__value">{{ session.avgHeartRate ?? '—' }}</span>
            <span class="metric-item__unit">bpm</span>
          </div>
        </div>
      } @else {
        <p class="loading-text">Sin sesiones</p>
      }
    </div>

    <!-- Key Metrics -->
    <div class="metric-card key-metrics">
      <h3>Métricas Clave</h3>
      <div class="metric-card__values metric-card__values--vertical">
        <div class="metric-row">
          <span class="metric-row__icon metric-row__icon--green"></span>
          <span class="metric-row__value">{{ weeklyLoadFormatted() }}</span>
          <span class="metric-row__label">Carga semanal</span>
        </div>
        <div class="metric-row">
          <span class="metric-row__icon metric-row__icon--teal"></span>
          <span class="metric-row__value">{{ avgCadence() ?? '—' }}</span>
          <span class="metric-row__label">Cadencia (spm)</span>
        </div>
      </div>
    </div>
  </div>
</div>
